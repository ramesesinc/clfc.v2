import com.rameses.annotations.*;
import com.rameses.common.*;

class MunicipalitySubdivisionRemoteCallHandler
{   
	@Service('SubdivisionService')
	def svc

	@ActiveDB('subdivision_task')
	def taskEm;

	

	public void approveSubdivisionByProvince(subdivision){
		def state = null;
		try{
			state = svc.getState( subdivision )
		}
		catch(e){
			//subdivision does not exist
			state = null;
		}

		if (state  && ! state.equalsIgnoreCase('APPROVED')){
			doApproveSubdivision(subdivision)
		}
	}

	private void doApproveSubdivision(subdivision){
		svc.getSubdividedLandsForApproval(subdivision.objid).each{
			svc.approveSubdividedLandFaasRecord(subdivision, it)
		}

		svc.getAffectedRpusForApproval(subdivision.objid).each{
			svc.approveAffectedRpuFaasRecord(subdivision, it)
		}

		taskEm.removeOpenTask(subdivision)
		subdivision.tasks.each{
			taskEm.save(it)
			svc.updateSignatories(it)
		}

		svc.insertFaasSignatories(subdivision)
		svc.approveSubdivision(subdivision)
		println 'Subdivision ' + subdivision.txnno + ' has been successfully approved.'
	}
}