import com.rameses.annotations.*
import com.rameses.common.*;

class ProvinceConsolidationWorkflowInterceptor
{
	
	@Service('RPTCloudNotificationService')
	def svc

	@ActiveDB('consolidation_task')
	def taskEm;


	@After(pattern="ConsolidationWorkflowService.signal", eval="#{args[0].state.matches('approver|provapprover') && args[0].action == 'completed' }") 
	public void submitToLguOnlineConsolidation( evt ) {
		println 'submitToLguOnlineConsolidation...'
		def consolidation = evt.args[0].data;
		consolidation.tasks = taskEm.getTasks(consolidation)
		notifyMunicipality(consolidation)
	}

	void notifyMunicipality(consolidation){
		println 'notify municipality....'
		def asyncreq = svc.createAsyncRequest('MunicipalityConsolidationRemoteCallHandler', 'approveConsolidationByProvince',  consolidation)
		svc.sendAsyncMessage(asyncreq[0], consolidation.lguid)
	}	
}
