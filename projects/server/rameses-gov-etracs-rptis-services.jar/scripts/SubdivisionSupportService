import com.rameses.annotations.*
import com.rameses.common.*;
import com.rameses.services.extended.*;
import com.rameses.util.*


class SubdivisionSupportService
{
    @Env
    def env
    
    @Service('SubdivisionService')
    def svc 

    @ActiveDB('subdivision')
    def em

    @ActiveDB('subdivision_task')
    def taskEm 

    @ActiveDB('faas_task')
    def faastaskEm

    @Service('ExaminationService')
    def examinationSvc

    @Service('RPTRequirementService')
    def reqSvc 

    @Service('FAASService')
    def faasSvc

    @Service('DBImageService')
    def imageSvc

    @Service('EntityService')
    def entitySvc 

    @Service('TxnRefService')
    def txnRef

    @Service('SubdivisionService')
    def subdivisionSvc


    @ProxyMethod
    public def buildSubdivisionData(subdivision){
        def data = [:]
        data.putAll(subdivisionSvc.openSubdivision(subdivision.objid))

        data.examinationfindings = examinationSvc.getFindings( subdivision.objid ).each{
            it.putAll(examinationSvc.open(it))
        }
        data.requirements = reqSvc.getRequirements(subdivision.objid)
        data.subdividedlands = subdivisionSvc.getSubdividedLands(subdivision.objid)
        data.affectedrpus = subdivisionSvc.getAffectedRpus(subdivision.objid)

        data.faases = []
        data.tasks = []
        def faas = null;

        data.subdividedlands.each{
            faas = [objid:it.newfaasid]
            data.faases << faasSvc.openFaas(faas)
            data.tasks << [type:'faas', tasks:faasSvc.getTasks(faas)]
        }

        data.affectedrpus.each{
            faas = [objid:it.newfaasid]
            data.faases << faasSvc.openFaas(faas)
            data.tasks << [type:'faas', tasks:faasSvc.getTasks(faas)]
        }

        data.faases.each{
            it.taxpayer = entitySvc.open(it.taxpayer)
        }

        data.tasks << [type:'subdivision', tasks:em.getTasks(subdivision)]
        data.image = getImageData(subdivision)
        return data 
    }


    @ProxyMethod
    public def postSubdivisionData(subdivision){
        println 'Saving subdivision'
        if (!subdivision._resubmitted){
            txnRef.checkReference(subdivision.motherfaasid)
            txnRef.delete(subdivision.objid)
            em.save(subdivision)
            txnRef.insertRef(subdivision.motherfaasid, subdivision.objid, 'FAAS is currently referenced by Subdivision No. ' + subdivision.txnno +'.')
        }

        println 'processing examinationfindings'
        subdivision.examinationfindings.each{
            examinationSvc.save(it)
        }

        println 'processing subdivision.requirements'
        subdivision.requirements.each{
            reqSvc.save(it)
        }

        println 'processing subdivision.faases'
        subdivision.faases.each{
            entitySvc.save(it.taxpayer)
            if (existFaas(it))
                faasSvc.updateFaas(it)
            else
                faasSvc.createFaas(it)
        }

        println 'processing subdivision.subdividedlands'
        subdivision.subdividedlands.each{
            em.save(it, 'subdividedland')
        }

        println 'processing subdivision.affectedrpus'
        subdivision.affectedrpus.each{
            em.save(it, 'affectedrpu')
        }

        subdivision.tasks.each{item ->
            if (item.type == 'subdivision'){
                item.tasks.each{ 
                    taskEm.save(it)
                }
            }
            else if (item.type == 'faas'){
                item.tasks.each{ 
                    faastaskEm.save(it)
                }
            }
            
        }

        saveImageData(subdivision.image)
    }


    @ProxyMethod
    public def buildRequirementsData(subdivision){
        def data = [:]
        data.requirements = reqSvc.getRequirements(subdivision.objid)

        def headers = []
        data.requirements.each{
            headers += imageSvc.getImages([refid:it.objid])
        }

        def chunks = []
        headers.each{
            chunks += imageSvc.getImageItems(it)
        }       
        data.image = [headers:headers, chunks:chunks]
        return data 
    }


    @ProxyMethod
    public void repostSubdivisionRequirements(reqdata){
        reqdata.requirements.each{
            reqSvc.save(it)
        }
        saveImageData(reqdata.image)
        println 'Subdivision requirements have been successfully reposted.'
    }
    

    void saveImageData(image){
        if (!image) return
        
        image.headers.each{
            imageSvc.saveHeader(it)
        }
        image.chunks.each{
            imageSvc.saveItem(it)
        }
    }

    def getImageData(subdivision){
        def headers = imageSvc.getImages([refid:subdivision.objid])
        subdivision.examinationfindings.each{
            headers += imageSvc.getImages([refid:it.objid])
        }
        subdivision.subdividedlands.each{
            headers += imageSvc.getImages([refid:it.newfaasid])
        }
        reqSvc.getRequirements(subdivision.objid).each{
            headers += imageSvc.getImages([refid:it.objid])
        }

        def chunks = []
        headers.each{
            chunks += imageSvc.getImageItems(it)
        }       
        return [headers:headers, chunks:chunks]
    }

    boolean existFaas(faas){
        return faasSvc.findFaasById(faas.objid) != null
    }
}


