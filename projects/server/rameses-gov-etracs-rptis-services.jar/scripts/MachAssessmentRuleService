import com.rameses.annotations.*;
import com.rameses.rules.common.*;
import com.rameses.util.*;

import rptis.mach.facts.*;
import rptis.mach.actions.*;

public class MachAssessmentRuleService  
{
	@Env 
	def env

	@Resource("RuleService")	
	def ruleSvc

	@ActiveDB("rule")
	def ruleDB

	@Service('DateService')
	def dtSvc 

	
	String RULESET = "machassessment";

	@ProxyMethod
	public def execute(rpu) throws Exception {
		def request = [rpu:rpu, variables:[], assessments:[]]; 
		request.facts = createFacts(request);
		request.actions = buildActions( request );

		def grps = ruleDB.getRulegroups( [ruleset: RULESET] );
		grps.each{g ->
			ruleSvc.execute( RULESET, request.facts, request.actions, g.name);
		}
		return rpu;
	}

	def createFacts(request){
		def rpu = request.rpu
		def facts = []

		def currDate = dtSvc.serverDate;
		def dt = currDate;
		if (rpu.issuedate){
			dt = java.sql.Date.valueOf( rpu.issuedate );
		}
		facts << new EffectiveDate( dt );
		facts << new CurrentDate(currDate);

		rpu.machuses.each{mu ->
			def mufact = new MachineActualUse(mu)
			facts << mufact

			mu.machines.each{md->
				facts << new MachineDetail(mufact, md)
			}
		}

		return facts
	}

	def buildActions(request) {
		def actions = new RuleAction();
		actions.addCommand( "calc-mach-bmv", new CalcMachineBMV( request:request));
		actions.addCommand( "calc-mach-depreciation", new CalcMachineDepreciation( request:request));
		actions.addCommand( "calc-mach-mv", new CalcMachineMV( request:request));
		actions.addCommand( "calc-mach-av", new CalcMachineAV( request:request));
		return actions;
	}

}

