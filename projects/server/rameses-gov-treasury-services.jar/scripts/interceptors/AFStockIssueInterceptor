import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import com.rameses.common.*
import com.rameses.services.extended.*

class AFStockIssueInterceptor {

	@Service("AFInventoryService")
	def afInventorySvc;

	@ActiveDB("af_inventory")
	def afInventoryDb;

	@ActiveDB("stockitem")
	def stockitem;

	@ActiveDB("af_control")
	def afControl;

	@ActiveDB("stockissue")
	def em;

	@After(pattern="StockIssueService.create")
	public void postReceipt( def evt ) { 
		def o = evt.result;
		def list = o.items.findAll{ it.qtyissued > 0 && it.items!=null };
		for( z in list ) {
			z.items.each {
				def m = [:];		
				m.controlid = it.controlid;
				m.refid = o.objid;
				m.reftype = "stockissue";	
				m.refno = o.issueno;
				m.refdate = o.dtfiled;
				m.afid = z.item.objid;
				m.unit = z.unit;
				m.startseries = (it.startseries!=null)?it.startseries: 0;
				m.endseries = (it.endseries!=null)?it.endseries: 0;
				m.startstub = (it.startstub!=null)?it.startstub: 0;
				m.endstub = (it.endstub!=null)?it.endstub: 0;
				m.prefix = it.prefix;
				m.suffix = it.suffix;
				m.qty= it.qtyissued;
				m.unitqty = it.unitqty;
				m.itemclass = z.item.itemclass;
				m.itemtype = z.item.type;
				m.txntype = o.reqtype;
				m.remarks = "ISSUED TO " + o.issueto.name
				m.cost = it.cost 
				afInventorySvc.postIssue(m);

				//break into each stub based on unitqty
				def unitqty = m.unitqty;
				int j = m.startseries;
				int stub = m.startstub;
				for(int i=m.startseries+unitqty; i<m.endseries+unitqty; i+=unitqty) {
					def head = [:];
					head.refid = m.refid;
					head.reftype = "stockissue";	
					head.refno = o.issueno;
					head.refdate = o.dtfiled;
				    head.startstub = stub;
				    head.endstub = stub;
				    head.afid = m.afid;
				    head.currentstub = stub;
					head.startseries = j;
					head.endseries = (i-1);
					head.currentseries = j;
					head.prefix = m.prefix;
					head.suffix = m.suffix;
					head.qty = unitqty;
					head.unit = m.unit;
					head.remarks = "RECEIVED FROM ISSUE";
					head.respcenter = o.issueto;
					if(!head.respcenter.type) head.respcenter.type = 'COLLECTOR';
					head.txntype = o.reqtype + "-RECEIPT";
					def q = afInventorySvc.postReceipt(head);

					def c = [:];
					c.putAll(q);
					c.owner = o.issueto;
					c.assignee = o.issueto;
					c.refdate = o.dtfiled;
					c.txnmode = 'ONLINE'
					c.active = 0;
					c.stubno = stub;
					afControl.create( c );
					j = i;
					stub+=1;
				}
			}
		}
	}

	@After(pattern="StockIssueService.open")
	public void afterOpen(evt) {
		def o = evt.result;
		o.items.each{
			def params = [afid: it.item.objid, unit: it.unit, stockissueid: it.parentid , respcentertype: 'COLLECTOR']
			it.handler =  it.aftype.toLowerCase() 
			it.items = afInventoryDb.getAFDetails(params).each {
				if( "cashticket".equals(it.aftype)) {
					it.startseries = null;
					it.endseries = null
				}
			}; 
			
		}
	}
	


}