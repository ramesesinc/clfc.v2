import com.rameses.annotations.*;
import com.rameses.util.*;
import com.rameses.functions.*;
import java.rmi.server.*;
import com.rameses.services.extended.*;
import com.rameses.rules.common.*;
import market.facts.*;
import market.actions.*;

public class MarketBillingService  {

	@Service("MarketBillRuleService")
	def ruleSvc;

	@Service("MarketAccountService")
	def acctSvc;

	@Service("DateService")
	def dateSvc;

	@Service("NumberService")
	def numSvc

	@ActiveDB(value="market_billing", em="market")
	def em;


	@ProxyMethod
	public def getBillItems( def o ) {
		def mu = acctSvc.open( o ); 
		def m = [objid: o.objid];
		m.startdate = mu.startdate;
		m.compromise = em.findCompromise( [acctid: o.objid ] );
		m.billdate  = dateSvc.serverDate;
		m.billingtype = o.billingtype;
		m.rate = mu.rate;
		return ruleSvc.execute( m );
	}

	@ProxyMethod 
	public def getReport( def o ) {
		def mu = acctSvc.open( o ); 
		def m = [objid: o.objid];
		m.startdate = mu.startdate;
		m.compromise = em.findCompromise( [acctid: o.objid ] );
		m.billdate  = dateSvc.serverDate;
		m.billingtype = o.billingtype;
		m.rate = mu.rate;
		
		def billing = ruleSvc.execute( m ); 

		def reportdata = [
			ownername: mu.owner.name,
			location : mu.rentalunit.section.title + ", " + mu.rentalunit.name,
			billdate : m.billdate,
			grandtotal : numSvc.roundA( billing.total, 2 )
		]

		reportdata.items = billing.items.each { itm -> 
			itm.monthdesc = dateSvc.getMonths().find{ it.index ==  itm.month }.name

			itm.subtotal = numSvc.roundA( (itm.amtdue + ( itm.surcharge ? itm.surcharge : 0.0 )), 2  )
			itm.amtdue = numSvc.roundA(itm.amtdue, 2)
			itm.surcharge = numSvc.roundA(itm.surcharge, 2)
			itm.interest = numSvc.roundA(itm.interest, 2)
			itm.total = numSvc.roundA(itm.total, 2)

		}
		
		return reportdata; 

	}



}

