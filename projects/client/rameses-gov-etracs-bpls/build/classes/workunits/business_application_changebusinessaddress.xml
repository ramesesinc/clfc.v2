<workunit>
    <invokers>
        <invoker folderid="/home/business/business_application" caption="Change Address"  
            action="start" target="window" role="BUSINESSINFO" index="102" />
        
    </invokers>
    
    <code>
         <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import java.rmi.server.*;
        import com.rameses.util.*;
        
        public class ChangeBusinessNameApplication extends PageFlowController {
        
            @Script("BusinessSearchUtil")
            def searchList;
            
            @Script("BusinessApplicationUtil")
            def application;
            
            @Script("BusinessAddressUtil")
            def address;

            def entity;
            
            void open() {
                application.init( [businessid:searchList.selectedItem.objid, apptype: 'CHANGE_BUSINESS_ADDRESS'] );
                entity.changetype = 'new';
            }
            
            void loadAddress() {
                if( entity.changetype != 'new' ) {
                    address.load();
                }
                else {
                    entity.business.address = [:];
                }
            }
            
            void submit() {
                if( entity.has_processing == true ) {
                    if(!MsgBox.confirm('There are still open application processed. Continuing will update their information. Proceed?')) 
                        throw new BreakException();
                }  
                else {
                    if(!MsgBox.confirm('You are about to update the business information. Proceed?')) 
                        throw new BreakException();
                }
                address.verify();
                application.save();
                MsgBox.alert('Update completed');
            }

        }
        ]]>
    </code>    
    
    <pageflow>
        <start>
            <transition to="search" />
        </start>
        
        <page name="search" title="Search Business Name (Change Name)">
            <transition to="select-type" caption="Next" name="next" mnemonic="N" immediate="false" action="open"/>
        </page>
        
        <page name="select-type" title="Select Type of Change Address">
            <transition to="search" caption="Back" mnemonic="B"/>
            <transition to="edit-address" caption="Next" name="next" mnemonic="N" action="loadAddress" />
        </page>
        
        <page name="edit-address" title="Business Address">
            <transition to="select-type" caption="Back" mnemonic="B"/>
            <transition to="end" caption="Next" name="next" mnemonic="N" action="submit" />
        </page>
        

        <end/>
    </pageflow>
    
    <pages>
        <page name="search" template="com.rameses.gov.etracs.bpls.view.SearchBusinessPage"/>
        <page name="select-type" template="com.rameses.gov.etracs.bpls.view.SelectChangeAddressType"/>
        <page name="edit-address" template="com.rameses.gov.etracs.bpls.view.EditBusinessAddressPage"/>
    </pages>
    
</workunit>