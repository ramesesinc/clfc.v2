<workunit>
    <invokers>
       <invoker type="rulemgmt:formActions" caption="BP Rules Analyzer" action="init"
            visibleWhen="#{ruleset == 'bpassessment'}" target="window" role="RULE_AUTHOR"/>
            
       <invoker folderid="/home/business" caption="Business Rule Analyzer" action="init" index="60" target="window" role="ASSESSOR,APPROVER,RULE_AUTHOR"/>
       <invoker type="bpanzalyzer:test" caption="BP Rules Test" action="init" target="window" />
       
       <invoker type="formActions" caption="Close" action="_close" immediate="true"/>
       <invoker type="formActions" caption="Run Assessment" action="run"/>
       <invoker type="formActions" caption="Run Bill" action="runBill"/>
       <invoker type="formActions" caption="Test Pay" action="testPay"/>

       <invoker type="formActions" caption="Clear Infos" action="clearInfos" immediate="true"/>
       
       <!-- lob actions -->
       <invoker type="lobActions" caption="Add" action="lob.add"  immediate="true"/>
       <invoker type="lobActions" caption="Remove" action="lob.remove" immediate="true" 
            visibleWhen="#{lob.selectedItem!=null}"/>
    </invokers>
    <code>
        <![CDATA[
            import com.rameses.rcp.common.*
            import com.rameses.rcp.annotations.*
            import com.rameses.osiris2.client.*
            import com.rameses.osiris2.common.*
            import com.rameses.rulemgmt.constraint.*;
            import com.rameses.rulemgmt.*;
            import java.rmi.server.*;
            
            class BPAssessmentAnalyzerController   {
            
                @Service("DateService")
                def dateSvc;
                
                @Script("BusinessLobUtil")
                def lob;

                @Script("BusinessApplicationUtil")
                def application;

                @Script("BusinessInfoUtil")
                def appinfo;
                
                @Script("BusinessAssessmentInfoUtil")
                def assessmentInfo;

                @Service("BPRequirementRuleService")
                def reqSvc;
                
                @Service("BusinessBillingService")
                def billSvc;

                @Binding
                def binding;

                def orgTypes = LOV.ORG_TYPES;
                String title = "Business Rule Assessment Simulator";
                String entityName = "bpassessment:analyzer";
                def entity = [business:[address:[:]], lobs:[], appinfos:[], assessmentinfos:[], taxfees:[]];
                
                def addressTypes = ["local", "nonlocal", "rented", "government"];
                
                void init() {
                    application.load();
                    entity.appyear = dateSvc.getServerYear();
                }
                
                void reset() {
                    init();
                }
                
                void run() {
                    lob.verify();
                    Modal.show(appinfo.update());
                    appinfo.verify();
                    Modal.show(assessmentInfo.calculate());
                    def p = reqSvc.execute( entity );
                    entity.requirements = p.requirements;
                    requirementModel.reload();
                    binding.refresh();
                }
               
                void runBill() {
                    if(!entity.taxfees) throw new Exception("Please run assessment first");
                    assessmentInfo.runBill();
                    assessmentInfo.refresh();
                }
               
                def requirementModel = [
                    fetchList: { o-> return entity.requirements; }
                ] as BasicListModel;
                
                void clearInfos() {
                    entity.appinfos?.clear();
                    entity.assessmentinfos?.clear();
                    entity.requirements?.clear();
                    entity.taxfees?.clear();
                    appinfo.refresh();
                    assessmentInfo.refresh();
                    requirementModel.reload();
                }
                
                def testPay() {
                    if( !entity.taxfees )
                        throw new Exception("Please run assessment first");
                    def h = { o->
                        def p = [:];
                        p.app = [objid:'APP', appno:'APPNO', appyear:entity.appyear, apptype: entity.apptype];
                        p.app.lobs = entity.lobs;
                        p.app.billitems = entity.taxfees;
                        p.payment = o;
                        binding.fireNavigation( Inv.lookupOpener( 'bpassessment:analyzer:payment', [entity:p] ));
                    }
                    return Inv.lookupOpener("cashreceipt:payoption", [handler:h, fullamount:entity.totals.total] );
                }
                
                
            }
        ]]>    
    </code>
    <pages>
        <page template="com.rameses.gov.etracs.rules.bpls.BPAssessmentAnalyzerPage"/>
    </pages>
</workunit>
