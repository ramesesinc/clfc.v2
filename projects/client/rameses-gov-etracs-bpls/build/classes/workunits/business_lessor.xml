<workunit>
    <invokers>
        <invoker type="business_lessor:create" caption="Building" action="init" target="popup"/>
        <invoker type="business_lessor_owner:create" caption="Building" action="initOwner" target="popup"/>
    </invokers>
    
    <code>
        <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import com.rameses.common.*;
        import java.rmi.server.*
        import com.rameses.util.*;
        import com.rameses.gov.etracs.bpls.business.*;
        
        class  BusinessLessorController {
        
            @Binding 
            def binding;
            
            @Service("EntityLookupService")
            def entityLookupSvc;
            
            @Service("BusinessLessorService")
            def service;
            
            def entity;
            int government;
            def owner;
            def lessorModel;
            def handler;
            def orgTypes = LOV.ORG_TYPES;
            
            void init() {
                entity = [objid:'BUSBLDG'+new UID(), barangay: [:], lessor:[:], government: government];
                lessorModel = [
                    fetchList: {o->
                        String stype = (entity.lessor.orgtype == 'SING') ?'INDIVIDUAL':'JURIDICAL';
                        def m = [searchtext:o.searchtext, type: stype];
                        return entityLookupSvc.getList(m);
                    },
                    onselect: { o->
                        entity.lessor = [objid:o.objid, name: o.name, address: o.address ];
                        binding.refresh( "entity.lessor.*" );
                    }
                ] as SuggestModel;
            }
            
            void initOwner() {
                if(!owner) throw new Exception("Owner must be passed");
                entity = [objid:'BUSBLDG'+new UID(), barangay: [:]];
                entity.government = 0;    
                entity.lessor = [objid:owner.objid, name: owner.name, address: owner.address ];
            }
            
            def addLessor() {
                def h = { o->
                    entity.lessor = [objid:o.objid, name: o.name, address: o.address ];
                    binding.refresh( "entity.lessor.*" );
                }
                String stype = (entity.lessor.orgtype == 'SING') ?'individualentity':'juridicalentity';
                return Inv.lookupOpener( stype + ":create", [ onselect:h ] );
            }
            
            def showLessor() {
                if(!entity.lessor) throw new Exception("Please select a lessor first");
                String stype = (entity.lessor.orgtype == 'SING') ?'individualentity':'juridicalentity';
                return InvokerUtil.lookupOpener( stype + ":open", [entity: entity.lessor] ); 
            }
            
            
            def doOk() {
                entity = service.save( entity );
                handler( entity );
                return "_close";
            }
            
            def doCancel() {
                return "_close";
            }
            
        }
        ]]>
    </code>
    
    <pages>
        <page template="com.rameses.gov.etracs.bpls.address.BuildingPage"/>
    </pages>
    
</workunit>